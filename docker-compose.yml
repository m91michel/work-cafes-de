# Production deployment configuration for Coolify
# Coolify will manage environment variables via its UI
# The env_file: .env.local references Coolify's generated .env file
# For local development, use docker-compose.local.yml

version: '3.8'

services:
  # Redis service for job queues
  redis:
    image: redis:7.2-alpine
    container_name: redis-cafes
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - cafes-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
  # # German version (cafezumarbeiten.de)
  # cafes-de:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #     args:
  #       LANGUAGE: de
  #       NODE_VERSION: 22
  #   image: work-cafes-de:de
  #   ports:
  #     - "3010:3010"
  #   env_file:
  #     - .env.local
  #   restart: unless-stopped
  #   networks:
  #     - cafes-network
  #   environment:
  #     - REDIS_URL=${REDIS_URL:-redis://redis:6379}
  #     - REDIS_DB=5

  # English version (awifiplace.com)
  cafes-en:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        LANGUAGE: en
        NODE_VERSION: 22
    image: work-cafes-de:en
    ports:
      - "3011:3010"  # Different port to avoid conflict
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - cafes-network
    environment:
      # Redis connection - Coolify will override these via env_file
      # Defaults for local development (Coolify will override)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - REDIS_DB=${REDIS_DB:-5}
      - REDIS_USERNAME=${REDIS_USERNAME:-}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

  # Worker service for background jobs
  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      cafes-en:
        condition: service_started
    restart: unless-stopped
    networks:
      - cafes-network
    environment:
      - NODE_ENV=production
      - CAFE_WORKER_CONCURRENCY=${CAFE_WORKER_CONCURRENCY:-1}
      - CRON_WORKER_CONCURRENCY=${CRON_WORKER_CONCURRENCY:-1}
      # Redis connection - Coolify will override these via env_file
      # Defaults for local development (Coolify will override)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - REDIS_DB=${REDIS_DB:-5}
      - REDIS_USERNAME=${REDIS_USERNAME:-}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
  
  bullboard:
    container_name: bullboard
    image: venatum/bull-board
    depends_on:
      redis:
        condition: service_healthy
      worker:
        condition: service_started
    restart: unless-stopped
    networks:
      - cafes-network
    ports:
      - "3232:3000"
    environment:
      # Redis connection - Coolify will override these via env_file
      # Bull Board uses REDIS_HOST and REDIS_PORT separately
      # Defaults for local development (Coolify will override)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-5}
      - REDIS_USERNAME=${REDIS_USERNAME:-}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - USER_LOGIN=${USER_LOGIN:-mathias}
      - USER_PASSWORD=${USER_PASSWORD:-mathias}

networks:
  cafes-network:
    driver: bridge

volumes:
  redis-data:
    driver: local

