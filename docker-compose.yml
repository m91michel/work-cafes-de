version: '3.8'

services:
  # Redis service for job queues
  redis:
    image: redis:7.2-alpine
    container_name: redis-cafes
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - cafes-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
  # German version (cafezumarbeiten.de)
  cafes-de:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        LANGUAGE: de
        NODE_VERSION: 22
    image: work-cafes-de:de
    ports:
      - "3010:3010"
    env_file:
      - .env.local
    restart: unless-stopped
    networks:
      - cafes-network
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - REDIS_DB=5

  # English version (awifiplace.com)
  cafes-en:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        LANGUAGE: en
        NODE_VERSION: 22
    image: work-cafes-de:en
    ports:
      - "3011:3010"  # Different port to avoid conflict
    env_file:
      - .env.local
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - cafes-network
    environment:
      # Redis connection to local Redis container
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - REDIS_DB=5

  # Worker service for background jobs
  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    env_file:
      - .env.local
    depends_on:
      redis:
        condition: service_healthy
      cafes-en:
        condition: service_started
    restart: unless-stopped
    networks:
      - cafes-network
    environment:
      - NODE_ENV=production
      - CAFE_WORKER_CONCURRENCY=5
      - CRON_WORKER_CONCURRENCY=1
      # Redis connection to local Redis container
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - REDIS_DB=5
  
  bullboard:
    container_name: bullboard
    image: venatum/bull-board
    depends_on:
      redis:
        condition: service_healthy
      worker:
        condition: service_started
    env_file:
      - .env.local
      - .env
    restart: unless-stopped
    networks:
      - cafes-network
    ports:
      - "3232:3000"
    environment:
      # Redis connection to local Redis container
      # Bull Board uses REDIS_HOST and REDIS_PORT separately
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=5
      - USER_LOGIN=mathias
      - USER_PASSWORD=mathias

networks:
  cafes-network:
    driver: bridge

volumes:
  redis-data:
    driver: local

