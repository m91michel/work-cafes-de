version: '3.8'

services:
  # # German version (cafezumarbeiten.de)
  # cafes-de:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #     args:
  #       LANGUAGE: de
  #       NODE_VERSION: 22
  #   image: work-cafes-de:de
  #   ports:
  #     - "3010:3010"
  #   env_file:
  #     - .env.local
  #   restart: unless-stopped
  #   networks:
  #     - cafes-network

  # English version (awifiplace.com)
  cafes-en:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        LANGUAGE: en
        NODE_VERSION: 22
    image: work-cafes-de:en
    ports:
      - "3011:3010"  # Different port to avoid conflict
    env_file:
      - .env.local
    restart: unless-stopped
    networks:
      - cafes-network
      - coolify  # Connect to Coolify network to access Redis
    environment:
      # Redis connection to Coolify Redis container
      # Using service name for DNS resolution (more reliable than IP)
      # Redis username and password should be set in .env.local
      - REDIS_URL=${REDIS_URL:-redis://r8ggcg04wgso08oso48sc00k:6379}
      - REDIS_USERNAME=${REDIS_USERNAME:-default}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=5

  # Worker service for background jobs
  # Note: Connects to Redis on host machine (not in Docker)
  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    env_file:
      - .env.local
    depends_on:
      - cafes-en
    restart: unless-stopped
    networks:
      - cafes-network
      - coolify  # Connect to Coolify network to access Redis
    environment:
      - NODE_ENV=production
      - CAFE_WORKER_CONCURRENCY=5
      - CRON_WORKER_CONCURRENCY=1
      # Redis connection to Coolify Redis container
      # Using service name for DNS resolution (more reliable than IP)
      # Redis username and password should be set in .env.local
      - REDIS_URL=${REDIS_URL:-redis://r8ggcg04wgso08oso48sc00k:6379}
      - REDIS_USERNAME=${REDIS_USERNAME:-default}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=5
  
  bullboard:
    container_name: bullboard
    image: venatum/bull-board
    depends_on:
      - worker
    env_file:
      - .env.local
      - .env
    restart: unless-stopped
    networks:
      - cafes-network
      - coolify  # Connect to Coolify network to access Redis
    ports:
      - "3232:3000"
    environment:
      # Redis connection to Coolify Redis container
      # Bull Board uses REDIS_HOST and REDIS_PORT separately
      # Using service name for DNS resolution
      - REDIS_HOST=${REDIS_HOST:-r8ggcg04wgso08oso48sc00k}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_USERNAME=${REDIS_USERNAME:-default}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=5
      - USER_LOGIN=mathias
      - USER_PASSWORD=mathias

networks:
  cafes-network:
    driver: bridge
  coolify:
    external: true  # Use existing Coolify network

